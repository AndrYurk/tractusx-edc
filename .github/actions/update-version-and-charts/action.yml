#################################################################################
#  Copyright (c) 2025 Cofinity-X GmBh
#
#  See the NOTICE file(s) distributed with this work for additional
#  information regarding copyright ownership.
#
#  This program and the accompanying materials are made available under the
#  terms of the Apache License, Version 2.0 which is available at
#  https://www.apache.org/licenses/LICENSE-2.0.
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
#  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
#  License for the specific language governing permissions and limitations
#  under the License.
#
#  SPDX-License-Identifier: Apache-2.0
#################################################################################

name: "Setup TractusX EDC in memory runtime"
description: "Setup TractusX EDC in memory runtime"
inputs:
  version:
    description: 'The version you want to release. Ref should be either main for latest releases or a tag for bugfixes.'
    required: true
runs:
  using: "composite"
  steps:
    - name: Bump version in /charts
      uses: mikefarah/yq@v4.45.2
      with:
        cmd: |
          find charts -name Chart.yaml -maxdepth 3 | xargs -n1 yq -i '.appVersion = "${{ inputs.version }}" | .version = "${{ inputs.version }}"'
    - name: Update Chart READMEs
      uses: addnab/docker-run-action@v3
      with:
        image: jnorwood/helm-docs:v1.10.0
        options: -v ${{ github.workspace }}/charts:/helm-docs
        run: |
          helm-docs --log-level debug

    - name: Compute next snapshot version
      id: compute_snapshot
      with:
      run: |
        VERSION=$(grep version= gradle.properties | cut -c9-)
        IFS=.- read -r MAJ MIN PAT SNAP <<< "$VERSION"
        if [ -z "$SNAP" ] && [[ "$VERSION" =~ \.0$ ]]; then
          NEXT_PATCH=$((PAT + 1))
          echo "new_version=$MAJ.$MIN.$NEXT_PATCH-SNAPSHOT" >> $GITHUB_OUTPUT
        fi
    - name: Bump version in gradle.properties
      if: steps.compute_snapshot.outputs.new_version != ''
      run: |
        sed -i "s/version=.*/version=${{ steps.compute_snapshot.outputs.new_version }}/" gradle.properties